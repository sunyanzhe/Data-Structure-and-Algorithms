# LCP

一开始用`load` `DOMContentLoaded`事件，用这两个事件来衡量页面加载速度是非常糟糕的，因为他们不一定与用户在屏幕上看到的内容相对应

以用户为中心的更新性能指标（例如`FCP`）它只能捕捉加载体验的最开始。如果页面最开始显示的是一个`loading`的动画，那这个指标就很难关注了

再后来，业界开始建议使用比如`FMP`和`Speed Index(SI)`，等性能指标来帮助补货初次渲染后的更多加载体验，但是这些指标非常复杂，难以解释，而且误报率比较高

## 什么是LCP

LCP（Largest Contentful Paint）用于衡量标准报告视口内可见的最大内容元素的渲染时间。为了提供良好的用户体验，网站应努力在开始加载页面的前2.5秒内进行最大内容渲染

相比FCP，这个指标就非常有价值了，因为这个值是根据页面加载渲染不断变化的，如果页面有一个loading动画，然后才渲染出具体内容，那么这额指标计算出来的就是具体内容的加载数独，而非loading动画的加载数独

## LCP考虑哪些元素

LCP目前并不会计算所有元素，因为这样会使这个指标变得非常复杂，它目前只关注下面的元素
1. img元素
2. image元素内的svg元素
3. video元素
4. 通过url（）函数加载背景图片的元素
5. 包含文本节点或其他内联文本元素子级的块级元素

## 如何计算LCP
页面上最大的元素即绘制面积最大的元素，所谓绘制面积可以理解为每个元素在屏幕上的‘占地面积’，如果元素延伸到屏幕外，或者元素被裁切了一部分，被裁切的部分不算入在内，只要真正显示在屏幕里的才算数

图片元素的面积计算方式稍微不同，因为通过css图片可以扩大或者缩小，也就是说，图片有两个面积：‘渲染面积’和‘真实面积’。在LCP的计算中，图片的绘制面积将获取较小的数值。

页面在加载过程中，是线性的，元素是一个一个渲染到屏幕的，所以‘渲染面积’最大的元素随时在发生变化

如果元素被删除，LCP算法将不再考虑该元素，如果被删除的元素刚好是绘制面积最大的元素，则时候新的绘制面积最大的元素创建一个新的性能条目


该过程将持续到用户第一次滚动页面或第一次用户输入（鼠标点击，键盘按键等），也就是说，一旦用户与页面开始产生交互，则停止报告新的性能指标

## 改善LCP

LCP较差的最常见原因是：
1. 服务器响应时间慢
2. 阻断渲染的Javascript和Css
3. 资源加载时间慢
4. 客户端渲染

所以我们从上面的角度去改善LCP：

1. 缓存
2. 尽量减小资源阻断渲染，CSS和Javascript压缩、合并、级联、内联
3. 对图片进行优化。转换图片的格式为JPG或者WEBP等等的格式，降低图片的大小，以加快请求的速度
4. 压缩
5. 使用CDN加快请求速度

6. JavaScript和css都是会阻断页面渲染的资源，需要尽可能的对CSS和JS文件进行压缩、延迟加载首屏无需使用的Javascript、内联关键CSS等来减小阻断时间

7. 服务端渲染， 使用服务端渲染可以确保首先在服务器上呈现页面内容，可以有效改善LCP，但是相比客户端渲染的缺点是会加大页面从而影响TTFB、服务端渲染需要等待所有js执行完毕后才能响应用户输入




# FID

FID即记录用户和页面进行首次交互操作所花费的时间。FIN指标影响用户对页面交互性和响应性的第一印象。为了提供良好的用户体验，站点应努力使首次输入延迟小于100毫秒

FID发生在FCP和TTI之间，因为这个阶段虽然页面已经显示出部分内容，但尚不具备完全的可交互性。这个阶段用户和页面交互，往往会有较大的延迟

浏览器接收到用户操作，主县城正在忙于执行一个耗时比较长的任务，只有当这个任务执行完成后，浏览器才能响应用户的输入操作。他必须等待的时间就是此页面上该用户的FID值

## 如何提高FID

减少Javascript执行时间
1. 缩小并压缩Javascript文件
2. 延迟加载首屏不需要的Javascript
3. 尽量减少未使用的polyfill


分解耗时任务
上面提到一个较长的耗时任务是影响FID的重要指标，任何阻塞主线程50毫秒或更长时间的代码段都可以被称为常任务
我们可以长的耗时任务拆分为较小的异步任务

# CLS
视觉稳定性

CLS会测量页面的整个生命周期中发生的每个意外的样式移动的所有单独布局更改得分的总和。布局的移动可能发生在可见元素从一帧到下一帧改变位置的任何时候。
为了提供良好的体验，CLS应该小于0.1

如何计算CLS
为了计算布局的偏移值，浏览器会查看两个渲染帧之间的视口大小和视口中不稳定元素的移动。布局偏移分是移动两个指标的成绩：影响分数和距离分数

## 影响分数
前一帧和当前帧的所有不稳定元素可见区域的并集（占视口总面积的一部分）是当前帧的影响分数
假设有一个元素在一帧中占据了视口的一半（50%）。然后，在下一帧中，元素下移视口高度的25%。这种情况下，其为总视口的75%，因此其影响分数为0.75

## 距离分数
布局偏移值方程的另一部分测量不稳定元素相对于视口移动的距离。距离分数是任何不稳定元素在框架中移动的最大距离（水平或垂直）除以视口的最大尺寸（宽度或高度，以较大的为准）
以上述情况为例，距离分数为0.25

因此，该案例中，影响分数为0.75，距离分数为0.25，因此位移分数0.75*0.25 = 0.1875

